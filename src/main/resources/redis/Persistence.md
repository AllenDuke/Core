# 持久化
## rdb
rdb文件记录的就是内存中的数据，通过fork一个子进程来把数据dump到rdb文件中（save阻塞，bgsave异步在子进程中执行、数据量大时
仍会阻塞父进程），适合数据量大（恢复快），但可能会丢失某一个时间段的数据。
## aof
可能导致性能下降（qps降低），默认关闭，类似追加日志。
### aof 重写（瘦身）
AOF的工作原理是将写操作追加到文件中，文件的冗余内容会越来越多。所以聪明的 Redis 新增了重写机制。当AOF文件的大小超过所设定的阈值时，
Redis就会对AOF文件的内容压缩。

Redis 会fork出一条新进程（父子进程读时共享，写时复制，os机制），读取内存中的数据，并重新写到一个临时文件中。并没有读取旧文件。
最后替换旧的aof文件。

触发机制：当AOF文件大小是上次rewrite后大小的一倍且文件大于64M时触发。这里的“一倍”和“64M” 可以通过配置文件修改。

这个时候，如果发生写命令，会将命令记录到缓冲区。

## 混合持久化
重启 Redis 时，我们很少使用 rdb 来恢复内存状态，因为会丢失大量数据。我们通常
使用 AOF 日志重放，但是重放 AOF 日志性能相对 rdb 来说要慢很多，这样在 Redis 实
例很大的情况下，启动需要花费很长的时间。
Redis 4.0 为了解决这个问题，带来了一个新的持久化选项——混合持久化。将 rdb 文
件的内容和增量的 AOF 日志文件存在一起。这里的 AOF 日志不再是全量的日志，而是自
持久化开始到持久化结束的这段时间发生的增量 AOF 日志，通常这部分 AOF 日志很小。

于是在 Redis 重启的时候，可以先加载 rdb 的内容，然后再重放增量 AOF 日志就可
以完全替代之前的 AOF 全量文件重放，重启效率因此大幅得到提升。
